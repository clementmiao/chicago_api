{% block api %}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpBiWzKU1WaL6QeiDenEPNp0UQhLsLnXs&sensor=false&libraries=visualization"></script>

{% endblock api %}

{% block init_map %}
    <script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
    <script type="text/javascript">

        var heatmap;

        var map;

        var heat_data;
        
        // window.onload = function() {
        function initialize() {
            var lat_long = new google.maps.LatLng({{latitude}}, {{longitude}});
            var mapOptions = {
                center: lat_long,
                zoom: {{zoom}},
                mapTypeId: google.maps.MapTypeId.{{map_type}}
            };

            map = new google.maps.Map(document.getElementById("{{ html_id }}"), mapOptions);

            var kml = "{{ kml }}"

            myParser = new geoXML3.parser({map: map});
            myParser.parse(kml);    

            heat_data = []
            {% if data %}

                function createMarker(latitude, longitude, string, icon, image) {
                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(latitude, longitude),
                        map: map,
                        icon: icon,
                        animation: google.maps.Animation.DROP,
                    })
                    var contentString = string;

                    if (image != "") {
                        contentString = '<IMG BORDER="0" ALIGN="Left" SRC=' + image + '>' + contentString
                    }

                    var infoWindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    google.maps.event.addListener(marker, 'click', function() {
                        infoWindow.open(map,marker);
                    }); 
                }

                {% for p in data %}
                
                    createMarker({{p.latitude}},{{p.longitude}}, "{{p.title|escapejs}}", "{{p.icon}}", "{{p.image}}");

                    var item = new google.maps.LatLng({{p.latitude}}, {{p.longitude}});
                    heat_data.push(item);

                {% endfor %}

                var pointArray = new google.maps.MVCArray(heat_data);


            
            {% endif %}

            
        }
        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
{% endblock init_map %}